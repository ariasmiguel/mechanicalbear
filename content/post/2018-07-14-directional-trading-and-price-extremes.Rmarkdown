---
title: Directional Trading and Price Extremes
author: Jason Taylor
date: '2018-07-14'
draft: TRUE
slug: directional-trading-and-price-extremes
summary: How do naked short options perform after large price movements and at price extremes?
categories:
  - Tastytrade
tags: []
header:
  caption: ''
  image: ''
---

### Market Measures - July 11, 2018

How do naked short options perform after large price movements and at price extremes?

*Letâ€™s compare selling naked options into multiple days of trading in one direction to a large weekly move.*  
*The tastytrade Research Department used 45 DTE options to see if the following setup worked from 2005 to now.*  
*If the market went lower, we sold a 30 delta put, and if it went higher, we sold a 30 delta call.*  
*We find that that selling puts into weakness (either measured by days or % moves) did yield a substantial profit.*  
*Selling calls into strength yielded decent profits when waiting for large percentage moves up over number of up days.*  

Here I will recreate this study and extend it to include more underlyings again with emphasis on learning new coding practices. As always recreating the Market Measure study will be done utilizing the tastytrade package on  [github](https://github.com/themechanicalbear/tastytrade).

#### Setup global options, load libraries:

```{r global_options, include = TRUE, results = FALSE}
knitr::opts_chunk$set(message = FALSE, tidy.opts = list(width.cutoff = 60)) 
suppressWarnings(suppressMessages(suppressPackageStartupMessages({
  library_list <- c("tastytrade", "dplyr", "ggplot2", "here", "purrr", "tidyr",
                    "data.table")
  lapply(library_list, require, character.only = TRUE)})))

stock_list <- c("SPY", "IWM", "GLD", "QQQ", "DIA", "TLT", "XLE", "EEM",
                "MA", "FB", "FXI", "SLV", "EWZ", "FXE", "TBT", "IBM")
tar_dte <- 45
tar_delta_put <- -.30
tar_delta_call <- .30
# down_3_days_results <- data.frame()
# all_closes <- data.frame()
# all_loss_table <- data.frame()
# all_results <- data.frame()
```

#### Study function

```{r study}
# Consecutive down days (1, 2, 3) and all days
# Weekly move greater than (1, 2, 3 %)

# Calculate win rate as percentage
# Calculate Avg. P/L in $

# 30 delta calls in up moves and 30 delta puts in down moves

# Symbol (SPY)
```

#### Data

```{r data}
stock <- "SPY"
options <- readRDS(paste0(here::here(), "/data/options/", stock, ".RDS")) %>%
  dplyr::mutate(mid = (bid + ask) / 2,
                m_dte = abs(dte - tar_dte))

each_day <- dplyr::distinct(options, quotedate, close)
```

#### Find consecutive move days

```{r find consecutive days}
consecutive_days <- options %>%
  dplyr::distinct(quotedate, close) %>%
  dplyr::arrange(quotedate) %>%
  dplyr::mutate(down_one = ifelse(close < lag(close, 1), 1, 0),
                down_two = ifelse(close < lag(close, 2), 1, 0),
                down_three = ifelse(close < lag(close, 3), 1, 0),
                up_one = ifelse(close > lag(close, 1), 1, 0),
                up_two = ifelse(close > lag(close, 2), 1, 0),
                up_three = ifelse(close > lag(close, 3), 1, 0))

down_one <- dplyr::filter(consecutive_days, down_one == 1)
down_two <- dplyr::filter(consecutive_days, down_one == 1, down_two == 1)
down_three <- dplyr::filter(consecutive_days, down_one == 1, down_two == 1, down_three == 1)

up_one <- dplyr::filter(consecutive_days, up_one == 1)
up_two <- dplyr::filter(consecutive_days, up_one == 1, up_two == 1)
up_three <- dplyr::filter(consecutive_days, up_one == 1, up_two == 1, up_three == 1)
```

#### Find weekly percentage changes
```{r find week percentages}
weekly_change <- options %>%
  dplyr::distinct(quotedate, close) %>%
  dplyr::arrange(quotedate) %>%
  dplyr::mutate(year = lubridate::year(quotedate),
                week = lubridate::week(quotedate)) %>%
  dplyr::group_by(year, week) %>%
  dplyr::mutate(rank = rank(quotedate)) %>%
  dplyr::filter(rank == min(rank) | rank == max(rank)) %>%
  dplyr::mutate(delta = close - lag(close, 1)) %>%
  dplyr::mutate(delta = ifelse(is.na(delta), max(delta, na.rm = TRUE), delta)) %>%
  dplyr::filter(rank == 1) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(return = (delta / close) * 100)%>% 
  dplyr::filter(!return == "-Inf")

wk_dwn_one <-  dplyr::filter(weekly_change, return <= -1)
wk_dwn_two <-  dplyr::filter(weekly_change, return <= -2)
wk_dwn_three <-  dplyr::filter(weekly_change, return <= -3)

wk_up_one <-  dplyr::filter(weekly_change, return >= 1)
wk_up_two <-  dplyr::filter(weekly_change, return >= 2)
wk_up_three <-  dplyr::filter(weekly_change, return >= 3)
```

#### Sell puts consecutive down days

```{r sell puts consecutive down days}
opens_all_days <- tastytrade::open_short_put(options, "SPY", tar_delta_put)
```

#### Close puts consecutive down days

```{r close puts consecutive down days}
all_days_results <- purrr::pmap_dfr(list(list(options),
                                         opens_all_days$quotedate,
                                         opens_all_days$expiration,
                                         opens_all_days$strike_put,
                                         opens_all_days$mid_put), 
                                    tastytrade::close_short_put_exp) %>%
  dplyr::right_join(each_day, by = c("open_date" = "quotedate")) %>%
  dplyr::filter(complete.cases(.))

# Filter results to those in each group
down_3_days_results <- dplyr::filter(all_days_results, open_date %in% unique(opens_down_3_days$quotedate))
down_2_days_results <- dplyr::filter(all_days_results, open_date %in% unique(opens_down_2_days$quotedate))
down_1_days_results <- dplyr::filter(all_days_results, open_date %in% unique(opens_down_1_days$quotedate))
down_3_pct_results <- dplyr::filter(all_days_results, open_date %in% wk_dwn_three$quotedate)
down_2_pct_results <- dplyr::filter(all_days_results, open_date %in% wk_dwn_two$quotedate)
down_1_pct_results <- dplyr::filter(all_days_results, open_date %in% wk_dwn_one$quotedate)
```

#### Results of the down days

```{r results down days}
# Win rates and average P/L per trade
mean_pl_3 <- mean(down_3_days_results$profit)
win_rate_3 <- nrow(dplyr::filter(down_3_days_results, profit > 0)) / 
  nrow(down_3_days_results)
mean_pl_2 <- mean(down_2_days_results$profit)
win_rate_2 <- nrow(dplyr::filter(down_2_days_results, profit > 0)) / 
  nrow(down_2_days_results)
mean_pl_1 <- mean(down_1_days_results$profit)
win_rate_1 <- nrow(dplyr::filter(down_1_days_results, profit > 0)) / 
  nrow(down_1_days_results)
mean_pl_all <- mean(all_days_results$profit)
win_rate_all <- nrow(dplyr::filter(all_days_results, profit > 0)) / 
  nrow(all_days_results)

down_days_results <- data.frame(metric = c("Win Rate", "Avg. P/L"),
                                all_days = c(win_rate_all, mean_pl_all),
                                one_day = c(win_rate_1, mean_pl_1),
                                two_days = c(win_rate_2, mean_pl_2),
                                three_days = c(win_rate_3, mean_pl_3))
print(down_days_results, digits = 2)
```




